import socket

import pickle

import numpy as np

import struct

def recv_all(sock, count):

Â Â Â Â Â Â Â Â buf = b''

Â Â Â Â Â Â Â Â while len(buf) < count:

Â  Â  Â Â Â Â Â Â Â Â to_read = min(4096, count - len(buf))

Â  Â  Â Â Â Â Â Â Â Â newbuf = sock.recv(to_read)

Â  Â  Â Â Â Â Â Â Â Â if not newbuf:

Â  Â  Â  Â  Â Â Â Â Â Â Â Â raise ConnectionError("ConexÃ£o encerrada antes de receber todos os dados")

Â  Â  Â Â Â Â Â Â Â Â buf += newbuf

Â Â Â Â Â Â Â Â return buf

def get_local_ip():

Â Â Â Â Â Â Â Â s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

Â Â Â Â Â Â Â Â s.connect(('8.8.8.8', 80))

Â Â Â Â Â Â Â Â ip = s.getsockname()[0]

Â Â Â Â Â Â Â Â s.close()

Â Â Â Â Â Â Â Â return ip

local_ip = get_local_ip()

print(f"p2 rodando em {local_ip}:6000")

p3_ip = input("Digite o IP do p3: ")

PORT = 6000

tcp = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

tcp.bind(('', PORT))

tcp.listen(5) Â # permite backlog de conexÃµes

print("p2 aguardando matrizes de p1...")

while True:

Â Â Â Â Â Â Â Â con, addr = tcp.accept()

Â Â Â Â Â Â Â Â print("ðŸ”· ConexÃ£o recebida de p1.")

Â Â Â Â Â Â Â Â try:

Â  Â  Â Â Â Â Â Â Â Â size_data = recv_all(con, 8)

Â  Â  Â Â Â Â Â Â Â Â size = struct.unpack('>Q', size_data)[0]

Â  Â  Â Â Â Â Â Â Â Â data = recv_all(con, size)

Â  Â  Â Â Â Â Â Â Â Â dados_recebidos = pickle.loads(data)

Â Â Â Â Â Â Â Â except Exception as e:

Â  Â  Â Â Â Â Â Â Â Â print(f"âŒ Erro ao receber: {e}")

Â  Â  Â Â Â Â Â Â Â Â con.close()

Â  Â  Â Â Â Â Â Â Â Â continue

Â Â Â Â Â Â Â Â con.close()

Â Â Â Â Â Â Â Â matriz_original = dados_recebidos['matriz']

Â Â Â Â Â Â Â Â start_time = dados_recebidos['start_time']

Â Â Â Â Â Â Â Â matriz_invertida = np.transpose(matriz_original)

Â Â Â Â Â Â Â Â pacote_para_p3 = {

Â  Â  Â Â Â Â Â Â Â Â 'matriz': matriz_invertida,

Â  Â  Â Â Â Â Â Â Â Â 'start_time': start_time

Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â data_p3 = pickle.dumps(pacote_para_p3)

Â Â Â Â Â Â Â Â size_p3 = struct.pack('>Q', len(data_p3))

Â Â Â Â Â Â Â Â tcp2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

Â Â Â Â Â Â Â Â tcp2.connect((p3_ip, PORT))

Â Â Â Â Â Â Â Â tcp2.sendall(size_p3)

Â Â Â Â Â Â Â Â tcp2.sendall(data_p3)

Â Â Â Â Â Â Â Â tcp2.close()

Â Â Â Â Â Â Â Â print("âœ… Matriz invertida enviada para p3.")


